# セキュリティキャンプの課題の回答

## Q.1 Web セキュリティクラス

講義のうち、特に受講したいと思う講義（複数可）に関して、その講義で「どのようなことを・なぜ学びたいか」を教えてください。とりわけ「なぜ学びたいか」の部分に関連して、いま応募を考えているあなたが感じておられる課題意識や、あなたの関心領域が伝わってくるような解答を歓迎します。

- OAuth 認証に関する講義:

  - 学んだことを自分の製作物として実装させようと考えているため
  - 開発する際に脆弱性が生まれやすい場所や認証の具体的な仕組みに関して、自分で考えて実装できるようになるために受講したいと考えています。

- 「Policy as Code 入門」:
  - 頻繁にポリシーの変更をできるようになるというメリットに興味を持っています
  - ソフトウェア開発におけるツールやアイデアを運用に生かす思考をもとにすることが技術として素晴らしいと感じたため
  - この講義で学び生かしたいと思っています
  - この考え方が具体的にどういう仕組みによって作られるのか、どういう言語でどうやって記述することで実装できるのかを学び、今回の講義で同時に学ぶ kubernetes や Github,AWS などに導入できるようにしたい
  - AWS や Github は使う人は周りにたくさんいるので、出来れば LT などでもこの考え方を広めていこうと思っています

## Q.2 これまでの経験について

以下の経験について、差し支えのない範囲でできるだけ具体的に教えてください。なお、この問は「この応募課題を提出する時点での経験」を問うものです。この応募課題を見た時点での経験はなくても構いませんし、この応募課題の記入にあわせての学習を歓迎します。

1. Web アプリケーションの設計・開発経験:

   - チームでごみの収集日のカレンダーを表示する Web アプリケーションを開発
   - インフラとプロジェクト管理を担当
   - 要件定義や機能要件、設計をチームで話し合いながら行った
   - バックエンド(PHP)と DB(MySQL)の開発も共同で行った
   - セキュリティキャンプへの応募にあたって Web アプリケーションを作成し、セキュリティに関する知識を実際のアプリケーションに落とし込めるようにしました

2. 一般のプログラミングの経験:

   - C 言語: 組み込み系のプログラミングやポインタを使用した関数の作成
   - Python: 計算式を入力すると自動で実行する関数の作成や Django を使用した Web アプリケーションの開発
   - PHP: Laravel を使った Web アプリケーションの製作や Web アプリケーションのセキュリティの勉強に使用
   - JavaScript: 基本的な関数やフレームワーク（Express、Node.js）の学習や Web アプリケーションのセキュリティの勉強に使用

3. コンテナ技術の利用経験:

   - Docker を使用して Web アプリケーションのインフラを構築

4. CI/CD 環境のセットアップ・利用経験:
   - Django を使用した Web アプリケーションのテストコードの作成と GitHub Actions での CI 環境の構築を行った
   - CD 環境は AWS を使用して EC2 インスタンスにデプロイする環境構築を試みたが、完全に構築できなかった

## Q.3 あなたの感心・興味について

Web に関連するサービス・プロダクトを作って提供することに関連する技術で、いまあなたが興味を持っているものがあれば、それについて自由に説明してください。少しでも Web との関連性がある技術であれば、それがハードウェア領域に近いものでも、ソフトウェア領域に近いものでも構いません。

1. Docker:
   私は現在 docker について勉強しています。理由としては以下の通りで

   - チーム開発や個人開発を通して操作による依存環境を壊さずに済む
   - 環境構築がプロジェクトファイルの配布のみで完了できて手間が省ける
   - 操作するコマンドが順番に記述されてて勉強しやすい
     Web アプリケーションを作るときによく使っていてチーム開発の時は開発領域ごとにコンテナを作り、テストで繋げました。
     まだまだ機能としては十二分に生かせていないので、CI/CD 環境で活用できるように勉強していきたいと思っています。

2. OAuth:
   最近セキュリティの勉強をしている中で自分が作ろうと思っているサービスに LINE アカウントを活用した OAuth2.0 を導入しようと思っていて、そのため OAuth2.0 について勉強をしています。OAuth2.0 に限らず ID 連携技術は、何よりもパスワードを覚えなくてもいいのがユーザ目線での大きなメリットだと思っています。
   ただクライアントでの実装が難しくて、ライブラリをどれを使えばいいのかや認証フローについて今一度理解を深めたりしています。これは今回のセキュリティキャンプで B クラスについてやってみたいと思うきっかけでもあります。
   今回のセキュリティキャンプの課題で OAuth 認証導入での気を付けなくてはいけないことが調べていく中で分かっていき、興味が深まったのと同時に、きちんと学んで実装する上で生かしていきたいと思っています。

## Q.4 Web に関連する脆弱性・攻撃技術の検証

[Top 10 web hacking techniques of 2022](https://portswigger.net/research/top-10-web-hacking-techniques-of-2022) は、Web に関するセキュリティリサーチャーの投票により作成された、2021 年に報告された興味深い Web に関する攻撃テクニック 10 選です。この Top 10 中の事例の中で、興味を持てたもの 1 つに関して、以下を説明してください。

### 1. 事例の概要

OAuth の処理シーケンスにおいてクライアントがトークンやコードが送信する際の癖を悪用され、サードパーティから読み取れるようになってしまう脆弱性があり、その内容を XSS などの攻撃手法で攻撃者に漏れてしまう脆弱性を Frans Rosén 氏が発見したことである。

### 2. 攻撃手法の詳細

OAuth 処理シーケンスの中でプロバイダとクライアントとが code や token を使ってやり取りする中での脆弱性を悪用する手法について詳しく説明する
具体的な攻撃手法（パラメータの指定方法によって攻撃手法も異なる）

1. まず OAuth クライアントがユーザー情報を参照するための権限を取得するため、認証サーバにリダイレクト URL を送信、CSRF 対策の state もここで作成し決まった指定方法（指定方法１とする）で送信する。
2. OAuth プロバイダがユーザーを認証してユーザー情報を参照するためのアクセストークンと code や token を指定したリダイレクト URL を決まった送信方法（指定方法２とする）で送信する。
3. しかしこのリダイレクト URL を OAtuh クライアントが受信する前に、攻撃者が OAuth クライアントに偽のリダイレクト URL を送信する。
4. state の認証失敗や code、token の指定方法の違いなどによって偽のリダイレクト URL が正常に受信されず、正規のリダイレクト URL の受信もできずに OAuth プロバイダへのアクセスに失敗する。このとき、認証に使われる code や token はユーザーの端末内に残る。
5. 攻撃者がユーザーに対して XSS などでスクリプトを実行させ、ユーザーの端末から認証に使われる code や token を盗み出す

### 3. その他その事例に関して感じたこと・気がついたこと

この攻撃が成立するための脆弱性

- 脆弱性１

  - OAuth クライアントが認可コードやトークンの受信に失敗したときにそれを OAuth プロバイダが検知できない脆弱性。これにより有効な認可コードやトークンが使われないままユーザーの端末内に残ってしまう。
    - この脆弱性の問題は 1 回しか使えない認可コードが使われないまま残ってしまうことが問題で、もし受信に失敗したことをプロバイダが把握できればいいのではないのかと思った。

- 脆弱性２
  - ユーザーの端末上でスクリプトが実行できてしまう脆弱性。postmessage メソッドで送信元を認証せずに実行したり、XSS などによるスクリプトの埋め込みなどによって発生する。
    - これはクライアントのセキュリティ対策に問題があり発生してしまう問題であるが、postmessage メソッドに関しては送受信側双方における対策が必要になる。

以上の脆弱性をもとに攻撃する。PKCE に関しては攻撃者があらかじめ認可サーバに対して攻撃者用の code_challenge を作成し、その値を使用すれば無効化できてしまうのでこの対策のみでは効果は得られないと予想する

個人的には認証情報が 1 対 1 で対応しているものが多いのに対して組み合わせによる認証を行っていないのが気になった、token や PKCE、code などがどのユーザーのための認証なのかをプロバイダが管理することによっていままでの技術でも対策ができると思った。

将来的に使う予定であったので LINE の OAuth システムでは token や code のやり取りはどのような方式なのか調べた。その内容についてセキュリティに関する仕組みについて記述する。
LINE における認可サーバのリダイレクト URI をデコードした結果は次の通りだった。フラグメントリダイレクトは使われていなかった。

```NULL
https://access.line.me/oauth2/v2.1/authorize?
response_type=code
&client_id=1234567890
&redirect_uri=https://example.com/auth?key=value
&state=12345abcde
&scope=profile%20openid
```

このように LINE ではクエリによって通信していて一般的な OAuth 認証のパラメータを指定していた。
しかし上で指定しているパラメータは OAuth 認証における最低限のパラメータのみで追加で PKCE に対応するための（code_challenge、code_challenge_method）パラメータやリプレイアタック防止のための nonce パラメータなども指定できる。また、ユーザー認証の仕方もパラメータで指定できる。

ユーザ認証が完了すると以下のコールバック URL にリダイレクトさせる

```NULL
https://example.com/callback?
code=abcd1234
&state=0987poi
&friendship_status_changed=true
```

また LINE はデベロッパーコンソールによって導入させたいアプリケーションと公開鍵の交換をしており、アクセストークンを取得する際に鍵を使ったクライアントの認証を行っている。

試しに実際に LINE の OAuth 認証を導入している「価格.com」というサイトに関して調べてみた

「LINE アカウントで登録」ボタンを押すた時に指定される URL をデコードすると

```NULL
https://access.line.me/oauth2/v2.1/login?
returnUri=/oauth2/v2.1/authorize/consent
?response_type=code
&client_id=1566447796
&redirect_uri=https://ssl.kakaku.com/auth/id/login/line/callback/
&state=a2db94d66c3e4f2cb823efe3e32396cc
&scope=openid+profile+email
&nonce=86c6e8d471394838b4a138a3039e240d
&bot_prompt=
&loginChannelId=1566447796
&loginState=uakJfEPKNHzen7CdDuTDkr#/
```

となっていた。これによりこのサイトの LINE の OAuth クライアントとしての ID は「1566447796」で認証したら[https://ssl.kakaku.com/auth/id/login/line/callback/]に code や state を送信する仕組みになっていることがわかる。

## Q.5 Web に関連する脆弱性・攻撃技術の検証

以下は Cookies Having Independent Partitioned State (CHIPS) という仕組みに関する Explainer です。[https://github.com/privacycg/CHIPS]
同 Explainer を読み、これに派生・関連した仕組みや動向を調査してください。その上で、可能な限りの実験を行いながら、以下の 5 点について簡潔にまとめてください。

### 1. CHIPS 自体の概要

これは 3rd_party_cookie を利用してクロスサイトトラッキングができるという課題意識のもと、このクッキーが作成されたのと同じトップレベルのサイトでのみ利用可能にさせるように変更することをブラウザが行う技術。これによりサードパーティに対してトップレベルが異なるサイトの場合同じサイトでもクッキーが送信されなくなることにより解決する。

### 2. CHIPS の背景課題について掘り下げて調査した結果

3rd_party_cookie を利用してクロスサイトトラッキングができるということは、より詳細には異なるサイトで同じ 3rd_party_cookie を使用したアクセスが行われるため、サードパーティが異なるサイトに対するアクセスを関連付けることができてしまうということである。これは Web ユーザーにとっては検索履歴が読み取られているのでプライバシーの侵害につながるものとなる。
では 3rd_party_cookie を廃止してはダメなのかというと技術的には可能だがその際はブラウザに大幅な機能変更が必要になりバグを引き起こす原因となる。
この問題を解決するために 3rd_party_cookie をパーティション化する技術が CHIPS である
この技術により、サードパーティからのクロスサイト Cookie に Partitioned 属性を追加することによりさらにトップレベルドメインで分割し、クロスサイトトラッキングを防止することが出来る。

しかし CHIPS のみによる cookie の制限はいくつかの課題が存在している

- ブラウザ拡張機能を使用したクロスサイト Cookie の制限の無効化ができてしまう
- 一つのドメインに対する cookie をトップレベルごとに分割するため、メモリを消費する
- CnameCloaking により回避ができてしまう

今広告業界では Cookie のソリューションを各ベンダーやプラットフォームがこぞって出している状況で
これらの問題の解決はブラウザのみの対策では難しく、Wen サイト、広告提供側も参加していかなくてはいけない

### 3. CHIPS や、それから派生した仕様・仕組みに関する実験

サイバーエージェントの現役エンジニアの方に現場の 3rd_party_cookie の規制による現場での影響を聞いてみた。今広告業界ではポストクッキーソリューションを各ベンダーやプラットフォームがどんどん出していて、未だ共通のソリューションとして使われる技術が定まっていない状況で現場のサービスそのものにはあまり影響はないとのことだった。

大手 Web 広告会社のサイバーエージェントがプライバシー保護関連の資料[https://developers.cyberagent.co.jp/blog/archives/36907/]を公開しており、現在の取り巻く環境について説明していた。
ここではクロスサイトトラッキングを最終的には健全な形に置き換えることを最終的な目標としており、そのための施策について記述されていた。主な施策としては２つあり、

- クロスサイトトラッキングの機能の置き換え
- ユーザーがコントロールできない手法によるトラッキングの防止

であった。そして 3rd_party_cookie は最終的には削除したいようだ。

### 4. その他気がついたこと・思ったこと ・疑問・感想

個人情報に関する問題はブラウザと広告主のいたちごっこになっており、ブラウザが対策をすると広告主たちが新たな方法で個人情報を収集しようとする。
この問題が解決されないのは保護されるべき個人情報がどこまでなのかが明確になっていないからでではないかと考えた。
また、認証局のように広告主が信頼できることを証明するシステムができるといい。

サイバーエージェントのプライバシー保護関連の資料で２つの施策を読み、置き換えに関しては新しい機能にした場合でもまた同じ問題になってしまうことになるので、個人情報を扱うことを前提とした機能として実装できるようにする必要があると考えた。

### 5. 疑問や感想を元に、さらに応募用紙提出後から掘り下げていくために取りたい行動

- ブラウザの拡張機能を作りたい。ユーザーの同意のもと、ドメインごとの cookie を編集して拡張機能で効率的に管理することで cookie によるメモリの大量消費を防ぐことができるのではと思ったので試してみたい。
- iframe でサイトを埋め込むときに header を指定できずに CORS を使えないことで、3rd_party_cookie の仕組みを再現できなかったのでほかの方法でできないか既存のサイトをもとに調べていきたい。最終的に再現できるようにしたい。
- サイバーエージェントの最新の記事の動向を追って、これからプライバシーとどうかかわるか知っておきたい。

## Q.6 Web サービス・プロダクト開発に関する仕組みの検討

あなたがチームで Web アプリケーションを開発していくための組織やプロセス、そしてそれを支える技術基盤の設計と実装を任されたとします。その際にセキュリティ上考慮すべきだと思う点を可能な限り列挙し、理由とともに説明してください。
解答の際には、一からすべて自分で考えるのではなく、OWASP や NIST 等が提示している何らかの文書（例: OWASP SAMM や NIST SSDF 等）を参考にしても構いません。また、気をつけるべき点を考えるだけではなく、具体的に何かを構築してみた場合は、ぜひそれも本設問の解答として含めてください。

- 情報のリソースに対する管理者、使用者が重複しないようにして、機密情報における役職をそれぞれ決め認可、認証を徹底する。組織における権限の割り当て方は経済産業省のサイバーセキュリティ経営ガイドラインをもとに作成し、文書化する。

  → 組織内における不正アクセスを防止するために、役割によって最小権限の原則のもと、権限を割り当てる。

これは Github のレポジトリのアクセス権限をチーム開発において担当していたのでメンバー各々が開発に必要な最小権限の原則の還元を割り当てるように意識した

- ログ管理

  → インシデント対応に必要なもののひとつで原因特定の際に必要になるため、ネットワークトラフィックを考慮してエラーが発生したときやいつもは発生しないログなどを記録しておく。また、開発者の行動ログなどをもとに不正アクセスを検出するときにも使用する。

SIGMA の Detection Engineering 入門として Windows のログの検出プログラムを書いてみたりしました。Kerberos 認証の証明書の認証失敗したログを検出する条件式を yml ファイルで記述しました。これは、Web アプリケーションの脆弱性を検出するときも役に立つと思います。

- 情報セキュリティインシデント管理

  → セキュリティにおけるインシデントの発生において決められた手順によって適切に対応し改善するため、責任者や CSIRT や SOC を設置する。また、対応の際に使用するマニュアルなども作成する。

- 開発におけるシステムの要件に応じて設計や構築、開発、基盤構築、テスト、保守などの作業ごとにセキュリティ対策を行うための要件、実装方法の定義、文書化しプロセスごとの作業や構築、設計における手順書やガイド文書を作成し、教育する。

  → 開発に携わるメンバーや、開発の受託者の全員がセキュリティを意識した対策を自発的に行うことは現実的ではないので、セキュリティ対策として必要な工程を開発初期段階からガイドラインとして取り決め、順守するように徹底させる。

- ガイドラインをもとに設計におけるセキュリティ対策の必要になる機能やサイトを特定し、それに合わせた設計をする。操作における快適性にも配慮する必要がある。

  → CSRF など設計の時点から対策について考えなくてはいけないので、token の認証をおこなう場所を決定したり、画面遷移で考慮する。

- 開発において XSS や CSRF、セッションハイジャックなどを考慮した開発をする

  → この攻撃手法は一例で、実際はもっといろいろな攻撃に対する対策が必要になる。脆弱性の発見が困難な場合、脆弱性診断ソフトやツールなどで検出した脆弱性に対処して対応することもできる。具体的にはセッション変数や CSRF トークン、エンコード、デコードなどを標準ライブラリを使って作成するなどがある。

- 開発時の権限管理

  → 主に DB や Linux が該当する。最小権限の原則のもと、処理を実行する際に使用するユーザーに対して最小限の権限を与える。設計の際に最小限の権限がどれなのかを定義する。

これは実際に Web アプリケーションの DB の SQL 文を実行する際、ユーザーに参照する表のみに対する SLECT 権限のみを与えるようにした。

- セキュリティの要件や手順書などをもとに具体的なセキュリティ対策を定義して実装する。暗号化や、DB の設計をもとに要塞化を行い、暗号化や可用性対策、パフォーマンスを担保することで安定性や拡張性を確保する。また、自然によるインシデントのための可用性対策も該当する。

  → 安定性や拡張性を確保する基盤を様々な技術によって構築する。具体的には、IPsec や認証局、クラスタリングシステムが該当する。
